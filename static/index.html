<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ERCOT / Oncor RAG Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 0.5rem; }
    #container {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.5rem 1.5rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.05);
    }
    textarea {
      width: 100%;
      min-height: 90px;
      padding: 0.5rem;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ddd;
      resize: vertical;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.5rem 1.3rem;
      border: none;
      background: #2563eb;
      color: white;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #answer {
      margin-top: 1.25rem;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .sources {
      margin-top: 1rem;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 0.75rem 1rem;
    }
    .source-item {
      margin-bottom: 0.5rem;
      font-size: 13px;
    }
    label {
      font-size: 13px;
      color: #555;
    }
    .inline {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      align-items: center;
    }
    .sources-block {
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px dashed #e5e5e5;
    }
    .sources-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 13px;
      color: #333;
    }
    select, input[type="number"] {
      padding: 0.25rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>ERCOT / Oncor æ–‡æ¡£é—®ç­”</h1>
  <p style="color:#666;margin-bottom:1rem;">é—®è´¹ç‡ã€æ¡æ¬¾ã€ERCOT åè®®ï¼Œç³»ç»Ÿä¼šè¿”å›ç­”æ¡ˆå’Œæ–‡æ¡£æ¥æºã€‚</p>
  <div id="container">
    <label for="query">é—®é¢˜ï¼ˆä¸­è‹±éƒ½è¡Œï¼‰</label>
    <textarea id="query" placeholder="ä¾‹å¦‚ï¼šè§£é‡Šä¸€ä¸‹Oncorçš„Distribution System Chargeæ˜¯æ€ä¹ˆè®¡è´¹çš„"></textarea>

    <div class="inline">
      <label for="bucket">æ–‡æ¡£æºï¼š</label>
      <select id="bucket">
        <option value="">è‡ªåŠ¨åˆ¤æ–­</option>
        <option value="oncor">Oncor</option>
        <option value="ercot">ERCOT</option>
      </select>

      <label for="topk">æ¥æºæ•°ï¼š</label>
      <input id="topk" type="number" value="4" min="1" max="10" style="width:60px;" />
    </div>

    <button id="askBtn">æé—®</button>

    <div id="answer"></div>
    <div id="sources" class="sources" style="display:none;"></div>
  </div>

<script>
  const btn = document.getElementById('askBtn');
  const queryEl = document.getElementById('query');
  const answerEl = document.getElementById('answer');
  const sourcesEl = document.getElementById('sources');
  const bucketEl = document.getElementById('bucket');
  const topkEl = document.getElementById('topk');
  let turn = 0; // ä¼šè¯è½®æ¬¡

  // ç®€å•çš„å‰ç«¯ä¼šè¯å†å²
  const history = []; // [{role:"user"/"assistant", content:"..."}]

  function renderChat() {
    // æŠŠå†å²å¯¹è¯ + æœ€æ–°ç­”æ¡ˆæ¸²æŸ“åœ¨ #answer
    const lines = history.map(h => {
      const who = h.role === 'user' ? 'ğŸ§‘' : 'ğŸ¤–';
      return `${who} ${h.content}`;
    });
    answerEl.textContent = lines.join('\n\n');
  }

  async function ask() {
    const query = queryEl.value.trim();
    if (!query) { alert('å…ˆè¾“å…¥é—®é¢˜'); return; }

    // ç”¨æˆ·æ¶ˆæ¯å…¥å†å²
    history.push({ role: "user", content: query });
    renderChat();

    btn.disabled = true;
    // sourcesEl.style.display = 'none';
    // sourcesEl.innerHTML = '';

    const payload = { query };
    const bucket = bucketEl.value;
    if (bucket) payload.bucket = bucket;
    const topk = parseInt(topkEl.value || '4', 10);
    if (topk) payload.top_k = topk;

    // åªå‘æœ€è¿‘ 6 è½®
    payload.history = history.slice(-6);

    turn += 1;

    try {
      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        history.push({ role: "assistant", content: `åç«¯é”™è¯¯ï¼š${res.status}` });
        renderChat();
        return;
      }
      const data = await res.json();

      // åŠ©æ‰‹æœºå™¨äººæ¶ˆæ¯å…¥å†å²
      history.push({ role: "assistant", content: data.answer || '(æ— å›ç­”)' });
      renderChat();

      // å±•ç¤ºæ¥æº
      if (data.sources && data.sources.length > 0) {
        sourcesEl.style.display = 'block';

        // åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥æºåŒºå—
        const block = document.createElement('div');
        block.className = 'sources-block';

        // æ ‡é¢˜ï¼šç¬¬å‡ è½®é—®é¢˜
        const title = document.createElement('div');
        title.className = 'sources-title';
        title.textContent = `Sources for Question ${turn}`;
        block.appendChild(title);

        // åˆ—å‡ºæœ¬è½®çš„æ¯æ¡æ¥æº
        data.sources.forEach((s) => {
          const div = document.createElement('div');
          div.className = 'source-item';
          div.textContent =
            `${s.doc || ''}  p.${s.page ?? '-'}  ${s.section ? 'sec: ' + s.section + ' ' : ''}` +
            (s.snippet ? ' â€” ' + s.snippet : '');
          block.appendChild(div);
        });

        // è¿½åŠ åˆ°æ€»å®¹å™¨æœ«å°¾ï¼ˆä¸æ¸…ç©ºæ—§å†…å®¹ï¼‰
        sourcesEl.appendChild(block);
      }
    } catch (err) {
      history.push({ role: "assistant", content: 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æˆ–ç½‘ç»œã€‚' });
      renderChat();
      console.error(err);
    } finally {
      btn.disabled = false;
      queryEl.value = '';   // å‘å®Œæ¸…ç©ºè¾“å…¥æ¡†
      queryEl.focus();
    }
  }

  btn.addEventListener('click', ask);
  queryEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) ask();
  });
</script>

</body>
</html>
